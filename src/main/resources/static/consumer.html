<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Passport Consumer</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f4f7fb;
        color: #1f2937;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 16px;
      }
      h1 {
        font-size: 1.4rem;
        margin: 0 0 8px;
      }
      .card {
        background: #ffffff;
        border: 1px solid rgba(99, 102, 241, 0.12);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 12px 32px rgba(148, 163, 184, 0.2);
      }
      label {
        display: block;
        font-weight: 600;
        margin: 10px 0 6px;
      }
      input, button {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        box-sizing: border-box;
        font-size: 0.95rem;
        background: #ffffff;
        color: #1f2937;
      }
      button {
        background: #7da4ff;
        border: none;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.2);
      }
      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
      }
      .message {
        margin-top: 12px;
        padding: 10px;
        border-radius: 6px;
        background: #ffe4e7;
        color: #9f1239;
        display: none;
      }
      .section-title {
        margin: 6px 0 10px;
        font-weight: 700;
        color: #475569;
      }
      .field-list {
        display: grid;
        gap: 6px;
      }
      .field-item {
        padding: 8px;
        border-radius: 6px;
        background: #f1f5f9;
      }
      .summary-grid {
        display: grid;
        gap: 8px;
      }
      .summary-item strong {
        display: inline-block;
        min-width: 140px;
      }
      @media (max-width: 600px) {
        h1 {
          font-size: 1.2rem;
        }
        .summary-item strong {
          min-width: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Passport Consumer View</h1>

      <section class="card">
        <div class="row">
          <div>
            <label for="passportId">Passport ID</label>
            <input id="passportId" type="number" min="1" placeholder="e.g. 1">
          </div>
        </div>
        <div class="row">
          <div>
            <label>&nbsp;</label>
            <button id="loadPassportBtn">Load Passport</button>
          </div>
        </div>
        <div class="message" id="errorMsg"></div>
      </section>

      <section class="card" id="compareCard" style="display:none;">
        <div class="section-title">Actions</div>
        <div class="row">
          <div>
            <a id="compareLink" href="/compare.html" style="display:inline-block;padding:10px 16px;background:#7da4ff;color:#fff;border-radius:6px;font-weight:600;text-decoration:none;box-shadow:0 8px 20px rgba(99,102,241,.2);">
              Compare with Another Passport
            </a>
          </div>
        </div>
      </section>

      <section class="card" id="summaryCard" style="display:none;">
        <div class="section-title">Summary</div>
        <div class="summary-grid" id="summaryGrid"></div>
      </section>

      <section class="card" id="detailsCard" style="display:none;">
        <!-- When template is available (DB mode), three sections appear.
             In-memory mode has no template endpoint so we fall back to a single "All Fields" section. -->
        <div id="templateSections" style="display:none;">
          <div class="section-title">Required Fields</div>
          <div class="field-list" id="requiredList"></div>
          <div class="section-title" style="margin-top:14px;">Optional Fields</div>
          <div class="field-list" id="optionalList"></div>
          <div class="section-title" style="margin-top:14px;">Other Fields</div>
          <div class="field-list" id="otherList"></div>
        </div>
        <div id="allFieldsSection" style="display:none;">
          <div class="section-title">All Fields</div>
          <div class="field-list" id="allFieldsList"></div>
        </div>
      </section>
    </div>

    <script src="/js/auth.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        const role = localStorage.getItem("role");
        if (!token || role !== "PLAYER") {
          window.location.href = "/login.html";
          return;
        }

        // cache dom nodes
        const passportIdInput = document.getElementById("passportId");
        const loadBtn = document.getElementById("loadPassportBtn");
        const errorMsg = document.getElementById("errorMsg");
        const compareCard = document.getElementById("compareCard");
        const compareLink = document.getElementById("compareLink");
        const summaryCard = document.getElementById("summaryCard");
        const detailsCard = document.getElementById("detailsCard");
        const summaryGrid = document.getElementById("summaryGrid");
        const templateSections = document.getElementById("templateSections");
        const requiredList = document.getElementById("requiredList");
        const optionalList = document.getElementById("optionalList");
        const otherList = document.getElementById("otherList");
        const allFieldsSection = document.getElementById("allFieldsSection");
        const allFieldsList = document.getElementById("allFieldsList");

        loadBtn.addEventListener("click", onLoadPassport);

        // support url like ?id=123
        const params = new URLSearchParams(window.location.search);
        const initialId = params.get("id");

        // if url has id, fill it
        if (initialId) {
          passportIdInput.value = initialId;
        }

        // auto load when id exists
        if (initialId) {
          onLoadPassport();
        }

        // load passport + template, then show ui
        async function onLoadPassport() {
          const passportId = passportIdInput.value.trim();
          console.log("[consumer] onLoadPassport click", { passportId });

          if (!passportId || Number.isNaN(Number(passportId))) {
            showError("请输入有效的 Passport ID（数字）。");
            return;
          }

          clearError();
          compareCard.style.display = "none";
          summaryCard.style.display = "none";
          detailsCard.style.display = "none";

          const url = `/api/passports/${passportId}`;
          const headers = {};
          if (token) {
            headers.Authorization = `Bearer ${token}`;
          }

          try {
            console.log("[consumer] fetch", url);
            const res = await fetch(url, { headers });
            console.log("[consumer] response status", res.status);

            const text = await res.text();
            let json = null;
            try {
              json = text ? JSON.parse(text) : null;
            } catch (e) {
              json = null;
            }

            if (!res.ok) {
              const msg = json?.error?.message || json?.message || text || `请求失败（${res.status}）`;
              showError(msg);
              return;
            }

            if (json?.success === true && json?.data) {
              const passport = json.data;
              const template = await fetchTemplateById(passport.templateId, token);
              renderSummary(passport);
              renderDetails(passport.fields || {}, template);
              // Show compare button with current passport pre-filled as id1.
              compareLink.href = `/compare.html?id1=${passport.passportId}`;
              compareCard.style.display = "block";
            }
          } catch (err) {
            console.log("[consumer] fetch error", err);
            showError("请求失败，请检查网络或后端服务。");
          }
        }

        // load template by id, fail then return null
        async function fetchTemplateById(templateId, authToken) {
          if (!templateId) {
            return null;
          }
          const headers = {};
          if (authToken) {
            headers.Authorization = `Bearer ${authToken}`;
          }
          try {
            const res = await fetch(`/api/templates/${templateId}`, { headers });
            const json = await res.json();
            if (!res.ok || !json.success) {
              return null;
            }
            return json.data;
          } catch {
            return null;
          }
        }

      // show summary info on top
      function renderSummary(passport) {
        summaryGrid.innerHTML = "";

        // basic info
        const summaryItems = [
          ["Passport ID", passport.passportId],
          ["Product ID", passport.productId],
          ["Template ID", passport.templateId],
          ["Status", passport.status],
          ["Completeness", passport.completenessScore],
          ["Confidence", passport.confidenceScore]
        ];

        // show some common fields if they exist
        const keyFields = ["name", "brand", "origin", "chemistry"];
        keyFields.forEach((key) => {
          if (passport.fields && passport.fields[key] !== undefined) {
            summaryItems.push([key, passport.fields[key]]);
          }
        });

        // render items
        summaryItems.forEach(([label, value]) => {
          const item = document.createElement("div");
          item.className = "summary-item";
          item.innerHTML = `<strong>${label}:</strong> ${formatValue(value)}`;
          summaryGrid.appendChild(item);
        });

        summaryCard.style.display = "block";
      }

      // Split fields into required / optional / other when template is available.
      // Falls back to a single "All Fields" list when no template (in-memory mode).
      // Switching to real DB automatically enables the three-section view.
      function renderDetails(fields, template) {
        if (!template) {
          templateSections.style.display = "none";
          allFieldsSection.style.display = "block";
          allFieldsList.innerHTML = "";
          Object.keys(fields || {}).forEach((key) => {
            allFieldsList.appendChild(makeFieldItem(key, fields[key]));
          });
          if (!allFieldsList.children.length) {
            allFieldsList.appendChild(makeFieldItem("(none)", ""));
          }
          detailsCard.style.display = "block";
          return;
        }

        allFieldsSection.style.display = "none";
        templateSections.style.display = "block";

        requiredList.innerHTML = "";
        optionalList.innerHTML = "";
        otherList.innerHTML = "";

        const requiredFields = template.requiredFields || [];
        const optionalFields = template.optionalFields || [];
        const usedKeys = new Set();

        requiredFields.forEach((key) => {
          usedKeys.add(key);
          requiredList.appendChild(makeFieldItem(key, fields[key]));
        });

        optionalFields.forEach((key) => {
          usedKeys.add(key);
          optionalList.appendChild(makeFieldItem(key, fields[key]));
        });

        Object.keys(fields || {}).forEach((key) => {
          if (!usedKeys.has(key)) {
            otherList.appendChild(makeFieldItem(key, fields[key]));
          }
        });

        if (!requiredList.children.length) requiredList.appendChild(makeFieldItem("(none)", ""));
        if (!optionalList.children.length) optionalList.appendChild(makeFieldItem("(none)", ""));
        if (!otherList.children.length) otherList.appendChild(makeFieldItem("(none)", ""));

        detailsCard.style.display = "block";
      }

      // make one "key: value" row
      function makeFieldItem(key, value) {
        const item = document.createElement("div");
        item.className = "field-item";

        const displayValue = value === undefined ? "—" : formatValue(value);
        item.textContent = `${key}: ${displayValue}`;

        return item;
      }

      // simple value to string
      function formatValue(value) {
        if (value === null || value === undefined) {
          return "";
        }
        if (typeof value === "object") {
          return JSON.stringify(value);
        }
        return String(value);
      }

      // show error message box
      function showMessage(message) {
        if (!message) {
          errorMsg.style.display = "none";
          return;
        }
        errorMsg.textContent = message;
        errorMsg.style.display = "block";
      }

        function showError(message) {
          showMessage(message);
        }

        function clearError() {
          showMessage("");
        }
      });
    </script>
  </body>
</html>
